<view class="container">
  
  <!-- é¡¶éƒ¨æ  -->
  <view class="header">
    <view class="welcome-text">ä»Šå¤©æƒ³åƒç‚¹ä»€ä¹ˆï¼ŸğŸ˜‹</view>
    <image 
      class="header-avatar" 
      src="{{userInfo.avatarUrl || '/images/default-avatar.png'}}" 
      mode="aspectFill"
      bindtap="toggleUserMenu"
    />
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-wrapper">
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>

  <!-- ä¸»å†…å®¹åŒº -->
  <view wx:else class="main-content">
    
    <!-- å·¦ä¾§åˆ†ç±»æ  -->
    <scroll-view class="sidebar" scroll-y>
      <block wx:for="{{categoryList}}" wx:key="id">
        <view 
          class="category-item {{currentCategory === index ? 'active' : ''}}"
          bindtap="switchCategory"
          data-index="{{index}}"
        >
          <view class="category-name">{{item.name}}</view>
          <view class="cat-badge" wx:if="{{item.count > 0}}">{{item.count}}</view>
        </view>
      </block>
    </scroll-view>

    <!-- å³ä¾§èœå“åˆ—è¡¨ -->
    <scroll-view 
      class="dish-list" 
      scroll-y 
      scroll-with-animation
      scroll-into-view="{{toView}}"
      bindscroll="onRightScroll"
    >
      <view class="dish-list-content">
        
        <block wx:for="{{categoryList}}" wx:key="id" wx:for-item="category" wx:for-index="catIndex">
          <view class="category-block" id="category-{{catIndex}}">
            
            <!-- åˆ†ç±»æ ‡é¢˜ -->
            <view class="category-sticky-header">{{category.name}}</view>
            
            <!-- èœå“åˆ—è¡¨ -->
            <block wx:for="{{category.dishes}}" wx:key="id" wx:for-item="dish">
              <view class="dish-item">
                
                <image class="dish-img" src="{{dish.image}}" mode="aspectFill" lazy-load></image>
                
                <view class="dish-info">
                  <view class="dish-name">{{dish.name}}</view>
                  <view class="dish-desc">{{dish.description || 'ç¾å‘³å®¶å¸¸èœ'}}</view>
                  
                  <view class="dish-bottom">
                    <view class="dish-price">{{dish.price}}</view>
                    
                    <!-- åŠ å‡æŒ‰é’® -->
                    <view class="stepper">
                      <view 
                        wx:if="{{cart[dish.id] > 0}}"
                        class="btn minus" 
                        catchtap="updateCart" 
                        data-type="minus" 
                        data-id="{{dish.id}}"
                        data-cat-index="{{catIndex}}"
                      >-</view>
                      
                      <view wx:if="{{cart[dish.id] > 0}}" class="count">
                        {{cart[dish.id]}}
                      </view>
                      
                      <view 
                        class="btn add" 
                        catchtap="updateCart" 
                        data-type="add" 
                        data-id="{{dish.id}}"
                        data-cat-index="{{catIndex}}"
                      >+</view>
                    </view>
                  </view>
                </view>
              </view>
            </block>
          </view>
        </block>
        
      </view>
    </scroll-view>
  </view>

  <!-- åº•éƒ¨è´­ç‰©è½¦æ  -->
  <view wx:if="{{totalCount > 0}}" class="bottom-bar">
    <view class="cart-icon-wrapper" bindtap="toggleCartDetail">
      <view class="cart-icon">ğŸ›’</view>
      <view class="badge">{{totalCount}}</view>
    </view>
    
    <view class="total-price" bindtap="toggleCartDetail">
      <text class="currency">Â¥</text>
      <text class="amount">{{totalPrice}}</text>
    </view>
    
    <button class="submit-btn" bindtap="goToOrder">é€‰å¥½äº†</button>
  </view>

  <!-- ç”¨æˆ·èœå•å¼¹çª— -->
  <view wx:if="{{showUserMenu}}" class="menu-mask" bindtap="toggleUserMenu">
    <view class="menu-popup" catchtap="preventBubble">
      
      <view class="menu-header">
        <image class="menu-avatar" src="{{userInfo.avatarUrl || '/images/default-avatar.png'}}" />
        <view class="menu-nickname">{{userInfo.nickname || 'æœªç™»å½•'}}</view>
      </view>
      
      <view class="menu-grid">
        <view class="menu-item" bindtap="handleMenuAction" data-type="address">
          <view class="menu-icon" style="background: #e1f5fe; color: #0288d1;">ğŸ“</view>
          <text>ä¿®æ”¹ä¿¡æ¯</text>
        </view>
        <view class="menu-item" bindtap="handleMenuAction" data-type="feedback">
          <view class="menu-icon" style="background: #e8f5e9; color: #388e3c;">ğŸ’¬</view>
          <text>èœå“åé¦ˆ</text>
        </view>
        <view class="menu-item" bindtap="handleMenuAction" data-type="donate">
          <view class="menu-icon" style="background: #fce4ec; color: #c2185b;">ğŸ§§</view>
          <text>æ‰“èµå¤§å¨</text>
        </view>
        <view class="menu-item" bindtap="handleMenuAction" data-type="order">
          <view class="menu-icon" style="background: #fff3e0; color: #f57c00;">ğŸ“„</view>
          <text>è®¢å•ç®¡ç†</text>
        </view>
      </view>
    </view>
  </view>

  <!-- è´­ç‰©è½¦è¯¦æƒ…å¼¹çª— -->
  <view wx:if="{{showCartDetail}}" class="cart-detail-mask" bindtap="toggleCartDetail">
    <view class="cart-detail-popup" catchtap="preventBubble">
      
      <view class="cart-header">
        <text class="cart-title">å·²é€‰å•†å“</text>
        <view class="clear-cart" bindtap="clearCart">
          <text>ğŸ—‘ï¸ æ¸…ç©º</text>
        </view>
      </view>
      
      <scroll-view class="cart-scroll" scroll-y>
        <block wx:for="{{cartList}}" wx:key="id">
          <view class="cart-item">
            <view class="cart-item-name">{{item.name}}</view>
            <view class="cart-item-right">
              <text class="cart-item-price">Â¥{{item.price * item.count}}</text>
              
              <view class="stepper">
                <view 
                  class="btn minus" 
                  catchtap="updateCart" 
                  data-type="minus" 
                  data-id="{{item.id}}"
                  data-cat-index="{{item.catIndex}}"
                >-</view>
                <view class="count">{{item.count}}</view>
                <view 
                  class="btn add" 
                  catchtap="updateCart" 
                  data-type="add" 
                  data-id="{{item.id}}"
                  data-cat-index="{{item.catIndex}}"
                >+</view>
              </view>
            </view>
          </view>
        </block>
      </scroll-view>
    </view>
  </view>

</view>
